<div class="set-redpacket-btn clearfix" id="change_redpacket">
    <span class="{if="$type==1"}on{/if}" data="pt">普通红包</span>
    <span class="{if="$type==2"}on{/if}" data="sq">拼手气红包</span>
</div>
<div class="set-redpacket-content">
    <div class="set-redpacket-box clearfix">
        <span>红包个数</span>
        <span class="fr unit">个</span>
        <input id="redpacket-num" class="redpacket-input" type="text" placeholder="输入个数">
    </div>
    <p class="error-tip">红包个数需大于一个</p>
    <div class="set-redpacket-box clearfix">
        <span id="s-input-name">{if="$type==1"}红包大小{else}流量总额{/if}</span>
        <img id="traffic-img" src="/static/img/setredpacket.png" style="{if="$type==1"}display:none;{/if}">
        <span class="fr arial unit">M</span>
        <input id="redpacket-traffic" class="redpacket-input" type="text" placeholder="{if="$type==1"}每个红包大小{else}输入总额{/if}">
    </div>
    <p class="error-tip">余额不足</p>
    
    <p class="textarea-box"><textarea class="set-redpacket-area" id="set_redpacketarea" rows="3" placeholder="这是我通过欧朋流量宝发的流量红包，点击直接抢！"></textarea></p>
    
    <p class="total-traffic mt1875">总额：<span class="c_traffic"><em id="total-traffic-num">0</em>M</span><span class="c_alltraffic">/<em id="all-traffic-num">{$total}</em>M</span></p>

    <a class="set-traffic-btn forbidden" id="send_btn">发给小伙伴</a>

    <p class="bottom-tip">发给小伙伴，自己也可以抢哦</p>
</div>
<!-- 分享弹层 start -->
<div class="cover" id="cover" style="display: none;"></div>
<div class="share-guide" id="guide" style="display: none;">
    <img src="/static/img/share-guid.png" alt="点击右上角... 然后点击分享"/>
</div>
<input type="hidden" value="{if="$type==1"}pt{else}sq{/if}" id="redpacket-type">
<!-- 分享弹层 end -->
<script>
    window.onload = function () {
        var btn_box = document.getElementById("change_redpacket"),
                    change_btn = btn_box.getElementsByTagName("span"),
                    num_input = document.getElementById("redpacket-num"),
                    traffic_input = document.getElementById("redpacket-traffic"),
                    btn = document.getElementById("send_btn"),
                    cover = document.getElementById("cover"),
                    guide = document.getElementById("guide"),
                    error_tip1 = getNext(num_input.parentNode.nextSibling),
                    error_tip2 = getNext(traffic_input.parentNode.nextSibling),
                    total_num = document.getElementById("total-traffic-num"),
                    all_num = document.getElementById("all-traffic-num"),
                    r_type = document.getElementById("redpacket-type").value,
                    redpacket_areaMessage = redpacket_areaTimeline = num_value = traffic_value = "",
                    redirect_url = "";
        //顶部按钮切换
        for(var i = 0 ;i < change_btn.length; i++){
            change_btn[i].addEventListener("click", changeTab, false);
        }
        //红包个数验证
        num_input.addEventListener('input', changeBtn, false);
        //流量验证
        traffic_input.addEventListener('input', changeBtn, false);    

        //点击发红包按钮
        btn.addEventListener("click", packHandler, false);
        //关闭浮层
        cover.addEventListener("touchend", function (e) {
            e.preventDefault();
            cover.style.cssText = "display:none";
            guide.style.cssText = "display:none";
        }, false);
        //阻止cover浮层上的滑动
        cover.addEventListener("touchmove", function (e) {
            e.preventDefault();
        }, false);
        function closeGuide(){
            cover.style.cssText = "display:none";//关闭分享引导层
            guide.style.cssText = "display:none";//关闭分享引导层
        }
        function packHandler() {
            if(this.className != 'set-traffic-btn forbidden'){
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4) {
                        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                            var responseObj = JSON.parse(xhr.responseText);
                            var code = responseObj.code;
                            if (code == 200) {//成功，可以发红包
                                // alert(responseObj.redirect_url);
                                redirect_url = responseObj.redirect_url;
                                var bodyHeight = window.innerHeight+document.body.scrollTop,
                                    pid = responseObj.message;
                                redpacket_areaMessage = redpacket_areaTimeline = document.getElementById("set_redpacketarea").value;
                                if(redpacket_areaMessage == ""){
                                    redpacket_areaMessage = '这是{$nickname}通过欧朋流量宝发的' + total_num.innerHTML + 'M流量红包，点击直接抢！'
                                }
                                if(redpacket_areaTimeline == ""){
                                    redpacket_areaTimeline = '{$nickname}发了' + total_num.innerHTML + 'M流量红包，快来抢啊！'
                                }
                                //alert(pid);
                                cover.style.cssText="display:block;height:"+bodyHeight+"px";//打开分享引导层
                                guide.style.cssText = "display:block";//打开分享引导层
                                //设置分享自定义事件
                                wx.ready(function () {
                                    /*发送给朋友*/
                                    wx.onMenuShareAppMessage({
                                        title: '我发了流量红包，快来抢啊！', // 分享标题
                                        desc: redpacket_areaMessage, // 分享描述
                                        link: redirect_url, // 分享链接
                                        imgUrl: '{$host}/images/share-pic.png', // 分享图标
                                        success: function () {
                                            //更新数据
                                            var xhr = new XMLHttpRequest();
                                            xhr.onreadystatechange = function () {
                                                if (xhr.readyState == 4) {
                                                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
                                                        var responseObj = JSON.parse(xhr.responseText);
                                                        var code = responseObj.code;
                                                        if (code == 200) {//成功，可以发红包
                                                            //跳转
                                                            closeGuide();
                                                            location.href='/success';
                                                        }else {//种种原因，不能发红包
                                                            alert(responseObj.message);
                                                            return;
                                                        }
                                                    }
                                                }
                                            }
                                             if(r_type == 'pt'){
                                                xhr.open("post", "/updateCommPacket", true);
                                            }else{
                                                xhr.open("post", "/updateLuckPacket", true);
                                            }
                                            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                                            xhr.send("pid="+pid);
                                            
                                        },
                                        cancel: function () {
                                            closeGuide();
                                        }
                                    });
                                    /*分享到朋友圈*/
                                    wx.onMenuShareTimeline({
                                        title: redpacket_areaTimeline, // 分享标题
                                        imgUrl: '{$host}/images/share-pic.png', // 分享图标
                                        link: redirect_url, // 分享链接
                                        success: function () {
                                            //更新数据
                                            var xhr = new XMLHttpRequest();
                                            xhr.onreadystatechange = function () {
                                                if (xhr.readyState == 4) {
                                                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
                                                        var responseObj = JSON.parse(xhr.responseText);
                                                        var code = responseObj.code;
                                                        if (code == 200) {//成功，可以发红包
                                                            //跳转
                                                            closeGuide();
                                                            location.href='/success';
                                                        }else {//种种原因，不能发红包
                                                            alert(responseObj.message);
                                                            return;
                                                        }
                                                    }
                                                }
                                            }
                                             if(r_type == 'pt'){
                                                xhr.open("post", "/updateCommPacket", true);
                                            }else{
                                                xhr.open("post", "/updateLuckPacket", true);
                                            }
                                            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                                            xhr.send("pid="+pid);
                                        },
                                        cancel: function () {
                                            closeGuide();
                                        }
                                    });
                                });
                            } else {//种种原因，不能发红包
                                alert(responseObj.message);
                                // redirect_url = responseObj.redirect_url;
                                // location.href=redirect_url;
                                return;
                            }
                        }
                    }
                }
                if(r_type == 'pt'){
                    xhr.open("post", "/getCommPacket", true);
                }else{
                    xhr.open("post", "/getLuckPacket", true);
                }
                xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                xhr.send("num="+num_input.value+"&value="+traffic_input.value);
            }
        }

        //改变底部按钮状态
        function changeBtn(){
            if(validate())
                btn.className = 'set-traffic-btn';
            else
                btn.className = 'set-traffic-btn forbidden';
        }
        //计算总流量
        function getTotalTraffic(){
            if(r_type == 'pt') {
                total_num.innerHTML = parseInt(traffic_input.value) * parseInt(num_input.value);
            }else if(r_type == 'sq'){
                total_num.innerHTML = traffic_input.value;
            }
        }
        //验证
        function validate(){
            num_input.value = num_input.value.replace(/\D|^0/g, "");
            traffic_input.value = traffic_input.value.replace(/\D|^0/g, "");
            var error_1 = getNext(num_input.parentNode.nextSibling),
                error_2 = getNext(traffic_input.parentNode.nextSibling);
            if(num_input.value == "" || parseInt(num_input.value) < 1){
                total_num.innerHTML = 0;
                error_1.style.visibility = "inherit";
                error_2.style.visibility = "hidden";
                return false;
            }else{
                error_1.style.visibility = "hidden";
                if(traffic_input.value != "" && parseInt(num_input.value) > 0){
                    if(parseInt(num_input.value) > parseInt(traffic_input.value) && r_type == "sq"){
                        error_2.innerHTML = "流量总额不够分配";
                        error_2.style.visibility = "inherit";   
                        return false;     
                    }else{
                        getTotalTraffic();
                        if(parseInt(total_num.innerHTML) > parseInt(all_num.innerHTML)){
                            error_2.innerHTML = "余额不足";
                            error_2.style.visibility = "inherit";   
                            return false;     
                        }else{
                            error_2.style.visibility = "hidden";
                            return true;
                        }
                    }
                }
            }
        }
        //顶部红包切换
        function changeTab(){
            if(this.className != 'on'){
                for(var i = 0 ;i < change_btn.length; i++){
                    change_btn[i].className = '';
                }
                this.className = 'on';
                var tmp_num = document.getElementById("redpacket-num").value,
                    tmp_traffic = document.getElementById("redpacket-traffic").value;
                document.getElementById("redpacket-type").value = r_type = this.getAttribute("data");
                document.getElementById("redpacket-num").value = num_value;
                document.getElementById("redpacket-traffic").value = traffic_value;
                num_value = tmp_num;
                traffic_value = tmp_traffic;
                document.getElementById("total-traffic-num").innerHTML = "0";
                if(r_type == 'pt'){
                    document.getElementById("traffic-img").style.cssText = "display:none;";
                    document.getElementById("s-input-name").innerHTML = "红包大小";
                    traffic_input.setAttribute("placeholder","每个红包大小");
                }else{
                    document.getElementById("traffic-img").style.cssText = "display:inline;";
                    document.getElementById("s-input-name").innerHTML = "流量总额";
                    traffic_input.setAttribute("placeholder","流量总额");
                }
            }
            changeBtn();
        }
        function openGuide() {
            if(this.className != 'set-traffic-btn forbidden'){
                var bodyHeight = window.innerHeight+document.body.scrollTop;
                cover.style.cssText="display:block;height:"+bodyHeight+"px";//打开分享引导层
                guide.style.cssText = "display:block";//打开分享引导层
            }
        }
        function closeGuide(){
            cover.style.cssText = "display:none";//关闭分享引导层
            guide.style.cssText = "display:none";//关闭分享引导层
        }
        function getNext(node){  
            if(node.nodeType == 1){   
                return node;   
            }  
            if(node.nextSibling){  
                return getNext(node.nextSibling);   
            }  
            return null;  
        }  
    };
</script>